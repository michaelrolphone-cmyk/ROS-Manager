<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Land Survey Field Tools</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-left">
          <button type="button" id="homeButton" class="home-button">
            „Åè <span>Home</span>
          </button>
          <h1>Survey Field Tools</h1>
        </div>
        <div class="header-actions">
          <!-- hidden select (internal) -->
          <select id="projectSelect" style="display: none"></select>

          <!-- custom project dropdown -->
          <div id="projectDropdownContainer" class="project-dropdown-container">
            <button
              type="button"
              id="projectDropdownToggle"
              class="project-dropdown-toggle"
            >
              <span class="label" id="projectDropdownLabel">No project</span>
              <span class="arrow">‚ñº</span>
            </button>
            <div id="projectDropdownMenu" class="project-dropdown-menu"></div>
          </div>

          <div id="projectActionsContainer" class="project-actions-container">
            <button
              type="button"
              id="projectActionsToggle"
              class="project-actions-toggle"
            >
              <span>Project Actions</span>
              <span class="arrow">‚ñº</span>
            </button>
            <div id="projectActionsMenu" class="project-actions-menu">
              <button type="button" id="newProjectButton">
                Create Project
              </button>
              <button type="button" class="danger" id="deleteProjectButton">
                Delete Current Project
              </button>
              <button type="button" id="importButton">Import</button>
            </div>
          </div>
        </div>
      </div>

      <div class="content">

        <div class="project-controls" id="projectControls">
          <input
            type="text"
            id="projectNameInput"
            placeholder="New Project Name"
          />
          <div style="display: flex; gap: 10px; flex-wrap: wrap">
            <button id="createProjectButton">Create Project</button>
            <button type="button" id="cancelProjectButton">Cancel</button>
          </div>
        </div>

        <div id="springboardSection" class="tool-section springboard active">
          <div id="springboardHero" class="springboard-hero">
            <div class="springboard-hero-header">
              <div class="springboard-hero-thumbnail" aria-hidden="true">
                <canvas
                  id="springboardCompositeCanvas"
                  width="180"
                  height="110"
                  role="presentation"
                ></canvas>
                <div
                  id="springboardCompositeEmpty"
                  class="springboard-hero-thumb-empty"
                >
                  Add traverse calls to see an overview
                </div>
              </div>
              <div class="springboard-hero-text">
                <p class="eyebrow">Active Project</p>
                <h1 id="springboardProjectTitle" class="springboard-hero-title">
                  <span id="springboardProjectName">No project selected</span>
                  <span
                    id="springboardProjectIndex"
                    class="springboard-index-badge"
                  ></span>
                </h1>
                <p
                  id="springboardProjectDescription"
                  class="springboard-hero-subtitle"
                >
                  Create or open a project to see its location context.
                </p>
              </div>
            </div>
            <div class="springboard-hero-details">
              <div class="meta-grid">
                <div class="meta-card">
                  <div class="label">Client</div>
                  <span class="value" id="springboardClientValue">‚Äî</span>
                </div>
                <div class="meta-card">
                  <div class="label">Client Phone</div>
                  <div class="value-row">
                    <span class="value" id="springboardClientPhoneValue"
                      >‚Äî</span
                    >
                    <a
                      id="springboardCallButton"
                      class="meta-action"
                      href="#"
                      target="_self"
                      aria-label="Call client"
                      >Call</a
                    >
                  </div>
                </div>
                <div class="meta-card">
                  <div class="label">Address</div>
                  <div class="value-row">
                    <span class="value" id="springboardAddressValue">‚Äî</span>
                    <a
                      id="springboardMapButton"
                      class="meta-action"
                      href="#"
                      target="_blank"
                      rel="noopener"
                      aria-label="Open address in maps"
                      >Map</a
                    >
                  </div>
                </div>
                <div class="meta-card">
                  <div class="label">Client Email</div>
                  <div class="value-row">
                    <span class="value" id="springboardClientEmailValue"
                      >‚Äî</span
                    >
                    <a
                      id="springboardEmailButton"
                      class="meta-action"
                      href="#"
                      target="_self"
                      aria-label="Email client"
                      >Email</a
                    >
                  </div>
                </div>
                <div class="meta-card">
                  <div class="label">Township / Range / Section</div>
                  <span class="value" id="springboardTrsValue">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          <div class="project-details-card" id="projectDetailsCard">
            <div class="project-details-header">
              <div>
                <p class="eyebrow" style="color: #475569">Project Details</p>
                <h3 style="margin-top: 2px">
                  Describe where and who you're working for
                </h3>
              </div>
              <div class="project-details-actions view-toggle">
                <button id="editProjectDetailsButton" class="secondary">
                  Edit Details
                </button>
              </div>
            </div>
            <form class="project-details-form" id="projectDetailsForm">
              <div class="project-details-grid">
                <div>
                  <label for="projectDetailName">Project Name</label>
                  <input
                    type="text"
                    id="projectDetailName"
                    placeholder="Subdivision 2024"
                  />
                </div>
                <div>
                  <label for="projectClientInput">Client</label>
                  <input
                    type="text"
                    id="projectClientInput"
                    placeholder="City of Exampleville"
                  />
                </div>
                <div>
                  <label for="projectClientPhoneInput">Client Phone</label>
                  <input
                    type="tel"
                    id="projectClientPhoneInput"
                    placeholder="(555) 123-4567"
                  />
                </div>
                <div>
                  <label for="projectClientEmailInput">Client Email</label>
                  <input
                    type="email"
                    id="projectClientEmailInput"
                    placeholder="client@example.com"
                  />
                </div>
                <div class="full-row">
                  <label for="projectAddressInput">Address</label>
                  <textarea
                    id="projectAddressInput"
                    rows="2"
                    placeholder="123 Main St, Exampleville, WA"
                  ></textarea>
                </div>
                <div>
                  <label for="projectTownshipInput">Township(s)</label>
                  <input
                    type="text"
                    id="projectTownshipInput"
                    placeholder="T12N, T13N"
                  />
                  <small class="app-hint"
                    >Separate multiple entries with commas</small
                  >
                </div>
                <div>
                  <label for="projectRangeInput">Range(s)</label>
                  <input type="text" id="projectRangeInput" placeholder="R3W" />
                  <small class="app-hint"
                    >Separate multiple entries with commas</small
                  >
                </div>
                <div>
                  <label for="projectSectionInput">Section(s)</label>
                  <input
                    type="text"
                    id="projectSectionInput"
                    placeholder="12, 13"
                  />
                  <small class="app-hint"
                    >Separate multiple entries with commas</small
                  >
                </div>
                <div>
                  <label for="projectSectionQuadrant">Section Quadrant</label>
                  <select id="projectSectionQuadrant">
                    <option value="">Not set</option>
                    <option value="NE">NE</option>
                    <option value="SE">SE</option>
                    <option value="SW">SW</option>
                    <option value="NW">NW</option>
                  </select>
                </div>
                <div>
                  <label for="projectAliquot1">Aliquots</label>
                  <div class="inline-inputs">
                    <select id="projectAliquot1">
                      <option value="">‚Äî</option>
                      <option value="NE">NE</option>
                      <option value="SE">SE</option>
                      <option value="SW">SW</option>
                      <option value="NW">NW</option>
                    </select>
                    <select id="projectAliquot2">
                      <option value="">‚Äî</option>
                      <option value="NE">NE</option>
                      <option value="SE">SE</option>
                      <option value="SW">SW</option>
                      <option value="NW">NW</option>
                    </select>
                    <select id="projectAliquot3">
                      <option value="">‚Äî</option>
                      <option value="NE">NE</option>
                      <option value="SE">SE</option>
                      <option value="SW">SW</option>
                      <option value="NW">NW</option>
                    </select>
                  </div>
                  <small class="app-hint"
                    >Choose up to three nested aliquots (inner most on the right).</small
                  >
                </div>
                <div>
                  <label for="projectPlatBook">Plat Book</label>
                  <input
                    type="text"
                    id="projectPlatBook"
                    placeholder="Book number"
                  />
                </div>
                <div>
                  <label for="projectPlatPageStart">Plat Page(s)</label>
                  <div class="inline-inputs">
                    <input
                      type="text"
                      id="projectPlatPageStart"
                      placeholder="Start"
                    />
                    <input
                      type="text"
                      id="projectPlatPageEnd"
                      placeholder="End (optional)"
                    />
                  </div>
                </div>
                <div class="full-row">
                  <label for="projectDescriptionInput">Description</label>
                  <textarea
                    id="projectDescriptionInput"
                    rows="3"
                    placeholder="Notes about scope, nearby landmarks, or routing instructions"
                  ></textarea>
                </div>
              </div>
              <div class="project-details-actions">
                <button type="submit" id="saveProjectDetailsButton">
                  Save Project Details
                </button>
              </div>
            </form>
          </div>

          <h2>Project Apps</h2>
          <p class="subtitle" style="margin-top: 0">
            Select a mini app to work with your current project.
          </p>
          <div class="springboard-grid">
            <button class="app-tile" data-target="vicinityMapSection">
              <span class="app-icon">üó∫Ô∏è</span>
              <span class="app-title">Vicinity Map</span>
              <span class="app-hint">Preview client address context</span>
            </button>
            <button class="app-tile" data-target="navigationSection">
              <span class="app-icon">üõ∞Ô∏è</span>
              <span class="app-title">Navigation</span>
              <span class="app-hint">Field navigation tools and routes</span>
            </button>
            <button class="app-tile" data-target="equipmentSection">
              <span class="app-icon">üì°</span>
              <span class="app-title">Equipment Setup</span>
              <span class="app-hint">Log base locations and crews</span>
            </button>
            <button class="app-tile" data-target="researchSection">
              <span class="app-icon">üìö</span>
              <span class="app-title">Historical Research</span>
              <span class="app-hint"
                >Capture controlling/supporting source documents</span
              >
            </button>
            <button class="app-tile" data-target="traverseSection">
              <span class="app-icon">üß≠</span>
              <span class="app-title">Traversals</span>
              <span class="app-hint">Build traverse paths and commands</span>
            </button>
            <button class="app-tile" data-target="pointsSection">
              <span class="app-icon">üìç</span>
              <span class="app-title">Point Files</span>
              <span class="app-hint"
                >Manage survey control and stakeout points</span
              >
            </button>
            <button class="app-tile" data-target="stakeoutSection">
              <span class="app-icon">üìè</span>
              <span class="app-title">Stakeout / Field Notes</span>
              <span class="app-hint">
                Document monument setting and field work with crews
              </span>
            </button>
            <button class="app-tile" data-target="levelingSection">
              <span class="app-icon">üéöÔ∏è</span>
              <span class="app-title">Differential Levels</span>
              <span class="app-hint"
                >Record BS/FS shots and running closures</span
              >
            </button>
            <button class="app-tile" data-target="evidenceSection">
              <span class="app-icon">üßæ</span>
              <span class="app-title">Evidence Records</span>
              <span class="app-hint">Document monuments and attach photos</span>
            </button>
            <button class="app-tile" data-target="chainEvidenceSection">
              <span class="app-icon">‚õìÔ∏è</span>
              <span class="app-title">Chain of Evidence</span>
              <span class="app-hint"
                >Trace corner history, filters, and export packets</span
              >
            </button>
            <button class="app-tile" data-target="qcSection">
              <span class="app-icon">‚úÖ</span>
              <span class="app-title">QC Dashboard</span>
              <span class="app-hint"
                >Compare traverses and levels against tolerances</span
              >
            </button>
            <button class="app-tile" data-target="exportsSection">
              <span class="app-icon">üì§</span>
              <span class="app-title">Exports &amp; Bundles</span>
              <span class="app-hint">Download audits, smart packs, and data</span>
            </button>
            <button class="app-tile" data-target="settingsSection">
              <span class="app-icon">‚öôÔ∏è</span>
              <span class="app-title">Global Settings</span>
              <span class="app-hint"
                >Manage equipment, crews, codes &amp; backups</span
              >
            </button>
            <button class="app-tile" data-target="helpSection">
              <span class="app-icon">‚ùî</span>
              <span class="app-title">Help</span>
              <span class="app-hint">Read the HELP.md guide in the app</span>
            </button>
          </div>
        </div>

        <div id="vicinityMapSection" class="tool-section">
          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow">Location Context</p>
                <h3 style="margin: 4px 0">Vicinity Map</h3>
                <p class="subtitle" style="margin-top: 4px">
                  Use the project address to preview a quick vicinity map for the
                  client site.
                </p>
              </div>
              <a
                id="vicinityMapLink"
                class="secondary"
                href="#"
                target="_blank"
                rel="noopener"
                aria-disabled="true"
              >
                Open in Maps
              </a>
            </div>
            <div class="vicinity-map-panel">
              <div class="vicinity-map-copy">
                <div class="meta-card">
                  <div class="label">Project Address</div>
                  <span class="value" id="vicinityMapAddress">‚Äî</span>
                </div>
                <p class="app-hint" id="vicinityMapStatus">
                  Add an address in Project Details to see a map preview.
                </p>
              </div>
              <div class="vicinity-map-frame">
                <div class="vicinity-map-placeholder" id="vicinityMapPlaceholder">
                  No address configured yet.
                </div>
                <img
                  id="vicinityMapImage"
                  src=""
                  alt="Vicinity map preview"
                  loading="lazy"
                />
              </div>
            </div>
          </div>
        </div>

        <div id="traverseSection" class="tool-section">
          <h3>Project Overview</h3>
          <canvas id="projectOverviewCanvas"></canvas>

          <hr />

          <h2>Records of Survey</h2>
          <div
            style="
              display: flex;
              gap: 10px;
              margin-bottom: 15px;
              flex-wrap: wrap;
            "
          >
            <input
              type="text"
              id="recordNameInput"
              placeholder="Record Name (e.g., Tract 1234)"
            />
            <button id="createRecordButton">+ New Record</button>
          </div>

          <div class="record-list" id="recordList"></div>

          <div id="editor" style="display: none">
            <h2 id="currentRecordName">Record Name</h2>
            <button class="danger" style="float: right" id="deleteRecordButton">
              Delete Record
            </button>

            <div class="form-grid">
              <div>
                <label for="recordStatus">Record Status</label>
                <select id="recordStatus">
                  <option value="Draft">Draft</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Ready for Review">Ready for Review</option>
                  <option value="Final">Final</option>
                </select>
              </div>
            </div>

            <h3>Starting Point Setup</h3>
            <div class="form-grid">
              <div>
                <label>Starting Point Number &amp; Link</label>
                <div class="start-point-row">
                  <input type="number" id="startPtNum" placeholder="1" />
                  <div
                    id="startFromDropdownContainer"
                    class="start-dropdown-container"
                  >
                    <button
                      type="button"
                      id="startFromDropdownToggle"
                      class="start-dropdown-toggle"
                    >
                      <span class="label" id="startFromDropdownLabel"
                        >Manual Start</span
                      >
                      <span class="arrow">‚ñº</span>
                    </button>
                    <div
                      id="startFromDropdownMenu"
                      class="start-dropdown-menu"
                    ></div>
                  </div>
                </div>

                <label>Northing (Y)</label>
                <input type="number" id="northing" placeholder="5000" />
              </div>
              <div>
                <label>Easting (X)</label>
                <input type="number" id="easting" placeholder="5000" />
                <label>Elevation (Z)</label>
                <input type="number" id="elevation" placeholder="0" />
              </div>
            </div>
            <label>Backsight Azimuth (dd.mmss)</label>
            <input type="number" id="bsAzimuth" placeholder="0.0000" />

            <h3>Basis and First Call</h3>
            <div class="form-grid">
              <div>
                <label>Basis of Bearing</label>
                <input type="text" id="basis" placeholder="N 45¬∞30'15&quot;E" />

                <label>First Distance (feet)</label>
                <input type="number" id="firstDist" placeholder="265.33" />
              </div>
              <div>
                <label for="closurePointNumber">Closure point number</label>
                <input
                  type="number"
                  id="closurePointNumber"
                  placeholder="1 (start)"
                />
                <p class="mini-note">
                  Pick the expected closing point number to compute misclosure
                  direction and ratio.
                </p>
                <label class="checkbox-inline" for="expectedToClose">
                  <input
                    type="checkbox"
                    id="expectedToClose"
                    checked
                  />
                  Traverse expected to close
                </label>
                <p class="mini-note">
                  Uncheck for open traverses, control extensions, or resections
                  where closure is not anticipated.
                </p>
              </div>
            </div>

            <table id="callsTable" class="calls-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Bearing</th>
                  <th colspan="2">Distance / Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <!-- Add button below list -->
            <div style="margin-top: 10px">
              <button id="addCallButton" class="success">
                + Add Subsequent Call
              </button>
            </div>

            <div class="card muted" id="closureSummaryCard">
              <div class="card-header">
                <h4 style="margin: 0">Closure report</h4>
                <span id="closureStatusChip" class="status-chip"></span>
              </div>
              <div class="closure-grid">
                <div>
                  <p class="label">Closure point</p>
                  <p id="closurePointLabel" class="value">‚Äî</p>
                </div>
                <div>
                  <p class="label">Linear misclosure</p>
                  <p id="closureLinear" class="value">‚Äî</p>
                  <span id="closureRatio" class="mini-note"></span>
                </div>
                <div>
                  <p class="label">Misclosure bearing</p>
                  <p id="closureDirection" class="value">‚Äî</p>
                </div>
                <div>
                  <p class="label">Angular misclosure</p>
                  <p id="closureAngular" class="value">‚Äî</p>
                </div>
              </div>
            </div>

            <!-- ACTIVE RECORD CANVAS HERE -->
            <h3 style="margin-top: 20px">Traverse Preview</h3>
            <canvas id="traverseCanvas"></canvas>

            <button id="generateCommandsButton" style="margin-top: 20px">
              Generate Carlson Commands
            </button>

            <h3>Carlson Input Commands</h3>
            <div class="command-grid">
              <!-- Create Point -->
              <div class="command-card" data-group="createPoint">
                <div class="command-card-header">
                  <span>Create Point</span>
                  <button type="button">Copy</button>
                </div>
                <pre class="command-preview" id="preview-createPoint">
(empty)</pre
                >
                <textarea
                  class="command-full"
                  id="full-createPoint"
                  readonly
                ></textarea>
              </div>

              <!-- Occupy Point -->
              <div class="command-card" data-group="occupyPoint">
                <div class="command-card-header">
                  <span>Occupy Point</span>
                  <button type="button">Copy</button>
                </div>
                <pre class="command-preview" id="preview-occupyPoint">
(empty)</pre
                >
                <textarea
                  class="command-full"
                  id="full-occupyPoint"
                  readonly
                ></textarea>
              </div>

              <!-- Draw Points (Traverse) -->
              <div class="command-card" data-group="drawPoints">
                <div class="command-card-header">
                  <span>Draw Points</span>
                  <button type="button">Copy</button>
                </div>
                <pre class="command-preview" id="preview-drawPoints">
(empty)</pre
                >
                <textarea
                  class="command-full"
                  id="full-drawPoints"
                  readonly
                ></textarea>
              </div>

              <!-- Draw Lines -->
              <div class="command-card" data-group="drawLines">
                <div class="command-card-header">
                  <span>Draw Lines</span>
                  <button type="button">Copy</button>
                </div>
                <pre class="command-preview" id="preview-drawLines">
(empty)</pre
                >
                <textarea
                  class="command-full"
                  id="full-drawLines"
                  readonly
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <div id="pointsSection" class="tool-section">
          <div class="card">
            <h3>Point File Manager</h3>
            <p class="subtitle" style="margin-top: 0">
              Import CSV point coordinate files to store and edit points with
              your project. Columns should be: point number, x (or lat), y (or
              lon), elevation, code (and description if last column),
              description.
            </p>
            <div
              style="
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                align-items: center;
              "
            >
              <button type="button" id="pointImportButton">
                Import Points CSV
              </button>
              <button type="button" id="addPointRowButton">
                Add Point Row
              </button>
              <button type="button" id="newPointFileButton">
                New Point File
              </button>
              <button type="button" id="renamePointFileButton">
                Rename Point File
              </button>
              <button type="button" id="downloadPointsButton" class="success">
                Download Points TXT
              </button>
              <label style="font-weight: 600; color: #0f172a">
                Coordinate View
                <select
                  id="pointViewModeSelect"
                  style="margin-left: 8px; padding: 8px"
                >
                  <option value="adjusted">Adjusted (editable)</option>
                  <option value="raw">Raw (read-only)</option>
                </select>
              </label>
              <label style="font-weight: 600; color: #1e40af">
                Active Point File
                <select
                  id="pointFileSelect"
                  style="margin-left: 8px; padding: 8px"
                >
                  <option>No point files</option>
                </select>
              </label>
              <label style="font-weight: 600; color: #0f172a">
                From Record
                <select
                  id="pointsFromRecordSelect"
                  style="margin-left: 8px; padding: 8px"
                >
                  <option>Select a project first</option>
                </select>
              </label>
              <button id="generatePointsFromTraverseButton" type="button">
                Generate Point File
              </button>
              <input
                type="file"
                id="pointsFileInput"
                accept=".csv,text/csv"
                style="display: none"
              />
            </div>

            <div class="card muted" style="margin-top: 12px">
              <div style="display: flex; gap: 12px; flex-wrap: wrap">
                <div style="flex: 1 1 220px; min-width: 220px">
                  <label for="adjustmentAlgorithm">Adjustment algorithm</label>
                  <select id="adjustmentAlgorithm">
                    <option value="">Select or type...</option>
                    <option value="Compass Rule">Compass Rule</option>
                    <option value="Transit Rule">Transit Rule</option>
                    <option value="Least Squares">Least Squares</option>
                    <option value="Rotation/Translation">Rotation/Translation</option>
                  </select>
                </div>
                <div style="flex: 2 1 320px; min-width: 280px">
                  <label for="adjustmentNotes">Adjustment notes</label>
                  <textarea
                    id="adjustmentNotes"
                    rows="2"
                    placeholder="Document raw vs adjusted handling, control points, or overrides"
                  ></textarea>
                </div>
                <div
                  style="display: flex; flex-direction: column; justify-content: flex-end"
                >
                  <button type="button" id="adjustmentSaveButton" class="secondary">
                    Capture Adjustment Record
                  </button>
                  <small id="adjustmentSummary" style="margin-top: 6px; color: #0f172a">
                    No adjustment record captured.
                  </small>
                </div>
              </div>
            </div>

            <div class="table-scroll">
              <table id="pointsTable">
                <thead>
                  <tr>
                    <th>Point #</th>
                    <th>X / Lat</th>
                    <th>Y / Lon</th>
                    <th>Elevation</th>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Actions</th>
                    <th title="Adjusted minus raw">ŒîX</th>
                    <th title="Adjusted minus raw">ŒîY</th>
                    <th title="Adjusted minus raw">ŒîZ</th>
                  </tr>
                </thead>
                <tbody id="pointsTableBody">
                  <tr>
                    <td colspan="10">
                      Create or select a project to manage points.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="levelingSection" class="tool-section">
          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Differential Levels</p>
                <h3 style="margin-top: 2px">Field Level Book</h3>
                <p class="subtitle" style="margin-top: 4px">
                  Capture backsight/foresight readings, check running sums, and
                  review closure error as you work.
                </p>
              </div>
              <div class="leveling-actions">
                <button id="exportLevelRunButton" class="secondary">
                  Export as PDF
                </button>
              </div>
            </div>

            <div class="leveling-toolbar">
              <div class="input-group">
                <label for="levelRunSelect">Level run</label>
                <select id="levelRunSelect"></select>
              </div>
              <button id="newLevelRunButton">+ New Run</button>
            </div>

            <div class="leveling-grid">
              <div>
                <label for="levelRunName">Run name</label>
                <input
                  type="text"
                  id="levelRunName"
                  placeholder="Benchmark loop, north ditch, etc."
                />
              </div>
              <div>
                <label for="levelStartPoint">Start point</label>
                <input
                  type="text"
                  id="levelStartPoint"
                  placeholder="BM-1"
                />
              </div>
              <div>
                <label for="levelStartElevation">Start elevation</label>
                <input
                  type="number"
                  step="0.0001"
                  id="levelStartElevation"
                  placeholder="100.00"
                />
              </div>
              <div>
                <label for="levelClosingPoint">Closing point</label>
                <input
                  type="text"
                  id="levelClosingPoint"
                  placeholder="BM-1 (return)"
                />
              </div>
              <div>
                <label for="levelClosingElevation">Closing elevation</label>
                <input
                  type="number"
                  step="0.0001"
                  id="levelClosingElevation"
                  placeholder="100.00"
                />
              </div>
              <div class="leveling-summary">
                <div>
                  <p class="label">Total BS</p>
                  <p id="levelTotalBs" class="value">0.000</p>
                </div>
                <div>
                  <p class="label">Total FS</p>
                  <p id="levelTotalFs" class="value">0.000</p>
                </div>
                <div>
                  <p class="label">Misclosure</p>
                  <p id="levelMisclosure" class="value">‚Äî</p>
                  <span id="levelClosureNote" class="mini-note"></span>
                </div>
              </div>
            </div>

            <div class="leveling-table-header">
              <h4 style="margin: 0">Shots</h4>
              <button id="addLevelEntryButton">+ Add entry</button>
            </div>
            <div class="table-wrapper">
              <table class="calls-table leveling-table">
                <thead>
                  <tr>
                    <th>Point</th>
                    <th>BS</th>
                    <th>FS</th>
                    <th>Notes</th>
                    <th>Rise / Fall</th>
                    <th>Elevation</th>
                    <th>Œ£BS</th>
                    <th>Œ£FS</th>
                    <th>Closure</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="levelEntriesTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="qcSection" class="tool-section">
          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Quality Control</p>
                <h3 style="margin-top: 2px">QC Dashboard</h3>
                <p class="subtitle" style="margin-top: 4px">
                  Configure tolerances and review traverses and level loops
                  against project limits.
                </p>
              </div>
              <div class="view-toggle">
                <span class="status-chip" id="qcOverallStatus"
                  >No checks yet</span
                >
              </div>
            </div>

            <div class="qc-grid">
              <div class="qc-panel">
                <h4 style="margin-top: 0">Project tolerances</h4>
                <div class="form-grid">
                  <div>
                    <label for="qcTraverseAngularTolerance"
                      >Traverse angular tolerance (deg)</label
                    >
                    <input
                      type="number"
                      step="0.01"
                      id="qcTraverseAngularTolerance"
                      placeholder="0.25"
                    />
                  </div>
                  <div>
                    <label for="qcTraverseLinearTolerance"
                      >Traverse linear misclosure per distance</label
                    >
                    <input
                      type="number"
                      step="0.0001"
                      id="qcTraverseLinearTolerance"
                      placeholder="0.0002"
                    />
                    <small class="app-hint"
                      >Use misclosure per unit distance (e.g., 0.0002 ‚âà
                      1:5000).</small
                    >
                  </div>
                  <div>
                    <label for="qcLevelTolerance"
                      >Level misclosure factor (√ó ‚àöK)</label
                    >
                    <input
                      type="number"
                      step="0.001"
                      id="qcLevelTolerance"
                      placeholder="0.02"
                    />
                    <small class="app-hint"
                      >K is the count of instrument setups/legs in the level
                      loop.</small
                    >
                  </div>
                </div>
                <div class="qc-actions">
                  <button id="saveQcSettingsButton">Save QC Settings</button>
                  <span class="mini-note" id="qcSettingsStatus"></span>
                </div>
              </div>

              <div class="qc-panel">
                <h4 style="margin-top: 0">Summary</h4>
                <div id="qcSummary" class="qc-summary">
                  Configure tolerances to start evaluating traverses and level
                  runs.
                </div>
                <div class="qc-actions" style="margin-top: 12px">
                  <button id="exportQcSummaryButton">Export QC Summary</button>
                  <span class="mini-note">
                    Includes tolerances, closure checks, and affected evidence
                    for failures.
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Traverses</p>
                <h3 style="margin-top: 2px">Traverse checks</h3>
              </div>
            </div>
            <div id="qcTraverseList" class="qc-list">
              Create a traverse to see closure checks.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Level loops</p>
                <h3 style="margin-top: 2px">Level loop checks</h3>
              </div>
            </div>
            <div id="qcLevelList" class="qc-list">
              Create a level run with a closing elevation to see misclosure
              checks.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Evidence</p>
                <h3 style="margin-top: 2px">Evidence QC</h3>
                <p class="subtitle" style="margin-top: 4px">
                  View each evidence entry with its current status and QC
                  completeness.
                </p>
              </div>
            </div>
            <div id="qcEvidenceList" class="qc-list">
              Log evidence to see QC completion status.
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Research</p>
                <h3 style="margin-top: 2px">Research QC</h3>
                <p class="subtitle" style="margin-top: 4px">
                  Track research documents, their status, and whether required
                  fields are complete.
                </p>
              </div>
            </div>
            <div id="qcResearchList" class="qc-list">
              Add research documents to track QC completion.
            </div>
          </div>
        </div>

        <div id="exportsSection" class="tool-section">
          <div class="card">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Exports</p>
                <h3 style="margin: 4px 0">Exports &amp; Bundles</h3>
                <p class="subtitle" style="margin-top: 0">
                  Export project archives, audit snapshots, and consolidated
                  document bundles from one place.
                </p>
              </div>
              <div class="view-toggle">
                <button type="button" id="exportCurrentButton" class="secondary">
                  Export Current Project
                </button>
                <button type="button" id="exportAllButton">Export All</button>
              </div>
            </div>
            <div class="mini-note">
              Exports include project data, linked evidence and research, and
              quality control summaries.
            </div>
          </div>

          <div class="card" id="exportStatusCard">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Backups</p>
                <h3 style="margin: 4px 0">Last export &amp; reminders</h3>
                <p class="subtitle" style="margin-top: 0">
                  Keep your export schedule current so local field data stays
                  protected.
                </p>
              </div>
              <div class="view-toggle">
                <button type="button" id="springboardExportNowButton">
                  Export Now
                </button>
              </div>
            </div>
            <div class="smartpack-meta">
              <div class="stat-chip">
                <div class="stat-label">Last export</div>
                <div class="stat-value" id="springboardLastExportValue">‚Äî</div>
              </div>
              <div class="stat-chip">
                <div class="stat-label">Export reminders</div>
                <div
                  class="mini-note warning"
                  id="springboardExportWarning"
                  style="display: none"
                ></div>
                <div class="mini-note" id="exportStatusHealthyMessage">
                  Exports are up to date.
                </div>
              </div>
            </div>
          </div>

          <div class="card" id="auditTrailCard">
            <div class="card-header">
              <div>
                <p class="eyebrow" style="color: #475569">Audit Trail</p>
                <h3 style="margin: 4px 0">Immutable Audit Trail</h3>
                <p class="subtitle" style="margin-top: 0">
                  Capture a timestamped, hashed snapshot of this project and
                  verify exported bundles against their checksum.
                </p>
              </div>
              <div class="view-toggle">
                <button id="createAuditSnapshotButton" class="secondary">
                  Create Audit Snapshot
                </button>
              </div>
            </div>
            <div class="audit-grid">
              <div>
                <div class="stat-chip" style="width: 100%">
                  <div class="stat-label">Latest snapshot</div>
                  <div class="stat-value" id="latestAuditTimestamp">None</div>
                  <div class="stat-meta" id="latestAuditMeta"></div>
                </div>
                <div class="mini-note" id="auditStatus"></div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap">
                  <button id="downloadLatestAuditButton" class="secondary">
                    Download Latest Audit Bundle
                  </button>
                  <button id="verifyAuditButton">Verify Audit Bundle</button>
                </div>
              </div>
              <div>
                <div class="stat-chip" style="width: 100%">
                  <div class="stat-label">Recent hashes</div>
                  <div id="auditEntriesList" class="mini-note">
                    No snapshots yet.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card" id="smartPackCard">
            <div class="card-header" style="align-items: flex-start">
              <div>
                <p class="eyebrow" style="color: #475569">Document Bundle</p>
                <h3 style="margin: 4px 0">Document Generation Smart Pack</h3>
                <p class="subtitle" style="margin-top: 0">
                  Export a consolidated packet with traverses, level loops,
                  evidence sheets, equipment setups, stakeout notes, QC summary,
                  and research references.
                </p>
              </div>
              <div class="smartpack-actions">
                <button id="smartPackExportButton">Export Smart Pack (HTML)</button>
                <button id="smartPackJsonButton" class="secondary">
                  Download Smart Pack JSON
                </button>
              </div>
            </div>
            <div class="smartpack-meta">
              <div class="stat-chip" id="smartPackStatusChip">
                <div class="stat-label">Export status</div>
                <div class="stat-value" id="smartPackStatusValue">Draft</div>
              </div>
              <div class="mini-note" id="smartPackStatusNote">
                Consolidated exports will include QC status labels for each
                section.
              </div>
            </div>
          </div>
        </div>

        <div id="evidenceSection" class="tool-section">
          <div class="card">
            <h3>Evidence Capture</h3>
            <p class="subtitle" style="margin-top: 0">
              Link field notes and photos directly to traverse points generated
              from your records of survey.
            </p>

            <div id="cpfValidationStatus" class="validation-callout hidden">
              <strong>CP&amp;F validation</strong>
              <p class="subtitle">
                Required Idaho CP&amp;F fields must be completed before a
                Corner Perpetuation Filing can be finalized. Click a tag to
                jump to the missing field.
              </p>
              <div class="cpf-chip-row"></div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceRecordSelect">Record</label>
                <div
                  id="evidenceRecordDropdownContainer"
                  class="start-dropdown-container evidence-record-dropdown"
                >
                  <button
                    type="button"
                    id="evidenceRecordDropdownToggle"
                    class="start-dropdown-toggle"
                  >
                    <span class="label" id="evidenceRecordDropdownLabel"
                      >Select a record</span
                    >
                    <span class="arrow">‚ñº</span>
                  </button>
                  <div
                    id="evidenceRecordDropdownMenu"
                    class="start-dropdown-menu"
                  ></div>
                </div>
                <select
                  id="evidenceRecordSelect"
                  style="display: none"
                ></select>
              </div>
              <div>
                <label for="evidencePointSelect">Traverse Point</label>
                <select id="evidencePointSelect"></select>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceType">Evidence Type</label>
                <select id="evidenceType">
                  <option value="">Select‚Ä¶</option>
                  <option>Iron Rod</option>
                  <option>Rebar w/ Cap</option>
                  <option>Concrete Monument</option>
                  <option>Fence Corner</option>
                  <option>Tree Witness</option>
                  <option>Occupation Line Evidence</option>
                  <option>Structure / Wall</option>
                  <option>Other</option>
                </select>
              </div>
              <div>
                <label for="evidenceCondition">Condition / Status</label>
                <select id="evidenceCondition">
                  <option value="">Select‚Ä¶</option>
                  <option>Found in good condition</option>
                  <option>Found disturbed</option>
                  <option>Leaning / damaged</option>
                  <option>Buried</option>
                  <option>Destroyed / unreliable</option>
                  <option>Suspect / conflicting</option>
                </select>
              </div>
              <div>
                <label for="evidenceStatus">Status</label>
                <select id="evidenceStatus">
                  <option value="Draft">Draft</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Ready for Review">Ready for Review</option>
                  <option value="Final">Final</option>
                </select>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceTownship">Township</label>
                <input
                  id="evidenceTownship"
                  type="text"
                  placeholder="T5N"
                />
              </div>
              <div>
                <label for="evidenceRange">Range</label>
                <input
                  id="evidenceRange"
                  type="text"
                  placeholder="R2E"
                />
              </div>
              <div>
                <label for="evidenceSection">Section</label>
                <input id="evidenceSection" type="text" placeholder="12" />
              </div>
            </div>

            <div>
              <label for="evidenceSectionBreakdown">Section breakdown</label>
              <input
                id="evidenceSectionBreakdown"
                type="text"
                placeholder="NE Cor, Lot 2, aliquots..."
              />
            </div>

            <div class="card padded">
              <div class="flex between" style="align-items: center">
                <div>
                  <div class="label">Additional TRS associations (optional)</div>
                  <div class="muted" id="associatedTrsHint">
                    Add TRS ties for common corners or adjoining townships.
                  </div>
                </div>
                <button type="button" id="addTrsAssociation">Add TRS tie</button>
              </div>
              <div class="form-grid" style="margin-top: 10px">
                <div>
                  <label for="additionalTrsTownship">Township</label>
                  <input
                    id="additionalTrsTownship"
                    type="text"
                    placeholder="T5N"
                  />
                </div>
                <div>
                  <label for="additionalTrsRange">Range</label>
                  <input
                    id="additionalTrsRange"
                    type="text"
                    placeholder="R2E"
                  />
                </div>
                <div>
                  <label for="additionalTrsSection">Section</label>
                  <input
                    id="additionalTrsSection"
                    type="text"
                    placeholder="12 or shared corner"
                  />
                </div>
                <div>
                  <label for="additionalTrsBreakdown">Section breakdown</label>
                  <input
                    id="additionalTrsBreakdown"
                    type="text"
                    placeholder="Lot, aliquot, quarter corner..."
                  />
                </div>
              </div>
              <div id="associatedTrsList" class="associated-trs-list"></div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceBasisOfBearing">Basis of bearing</label>
                <input
                  id="evidenceBasisOfBearing"
                  type="text"
                  placeholder="Record of Survey 2020-123, grid north..."
                />
              </div>
              <div>
                <label for="evidenceMonumentType">Monument type</label>
                <input
                  id="evidenceMonumentType"
                  type="text"
                  placeholder="Iron rod, brass cap, stone..."
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceMonumentMaterial">Monument material</label>
                <input
                  id="evidenceMonumentMaterial"
                  type="text"
                  placeholder="Steel, aluminum, concrete..."
                />
              </div>
              <div>
                <label for="evidenceMonumentSize">Monument size</label>
                <input
                  id="evidenceMonumentSize"
                  type="text"
                  placeholder="5/8&quot; x 24&quot; rebar, 3&quot; brass cap..."
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceSurveyorName">Responsible surveyor</label>
                <input
                  id="evidenceSurveyorName"
                  type="text"
                  placeholder="Name"
                />
              </div>
              <div>
                <label for="evidenceSurveyorLicense">Idaho PLS #</label>
                <input
                  id="evidenceSurveyorLicense"
                  type="text"
                  placeholder="12345"
                />
              </div>
              <div>
                <label for="evidenceSurveyorFirm">Firm</label>
                <input
                  id="evidenceSurveyorFirm"
                  type="text"
                  placeholder="Firm (optional)"
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceSurveyDates">Survey date(s)</label>
                <input
                  id="evidenceSurveyDates"
                  type="text"
                  placeholder="2024-03-01 and 2024-03-03"
                />
              </div>
              <div>
                <label for="evidenceSurveyCounty">County</label>
                <input
                  id="evidenceSurveyCounty"
                  type="text"
                  placeholder="Ada County"
                />
              </div>
              <div>
                <label for="evidenceRecordingInfo">Recording info</label>
                <input
                  id="evidenceRecordingInfo"
                  type="text"
                  placeholder="Instrument #, Book/Page"
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="evidenceCornerType">Corner Type (PLSS)</label>
                <select id="evidenceCornerType">
                  <option value="">Select‚Ä¶</option>
                  <option>Section corner</option>
                  <option>Quarter corner</option>
                  <option>Sixteenth corner</option>
                  <option>Lot corner</option>
                  <option>Meander corner</option>
                  <option>Witness corner</option>
                  <option>Other</option>
                </select>
              </div>
              <div>
                <label for="evidenceCornerStatus">Corner Status</label>
                <select id="evidenceCornerStatus">
                  <option value="">Select‚Ä¶</option>
                  <option>Original monument found</option>
                  <option>Perpetuation monument found</option>
                  <option>Obliterated/restored by collateral evidence</option>
                  <option>Lost/proportionally restored</option>
                  <option>New monument set</option>
                  <option>Witness corner set</option>
                </select>
              </div>
            </div>

            <label for="evidenceNotes">Notes / Field sketch</label>
            <textarea
              id="evidenceNotes"
              rows="3"
              placeholder="Describe monument, occupation, caps, witness ties, etc."
            ></textarea>

            <div class="form-grid">
              <div>
                <label for="evidenceTieDistance">Tie Distance</label>
                <input
                  id="evidenceTieDistance"
                  type="text"
                  placeholder="24.50 ft"
                />
              </div>
              <div>
                <label for="evidenceTieBearing">Tie Bearing</label>
                <input
                  id="evidenceTieBearing"
                  type="text"
                  placeholder="N35¬∞E"
                />
              </div>
            </div>

            <label for="evidenceTieDescription">Tie Description</label>
            <textarea
              id="evidenceTieDescription"
              rows="2"
              placeholder="Tree blaze, fence post, rebar, etc."
            ></textarea>

            <label for="evidenceTiePhotos">Tie Photos</label>
            <input
              id="evidenceTiePhotos"
              type="file"
              accept="image/*"
              multiple
            />
            <button type="button" id="addEvidenceTie">Add Tie</button>
            <p class="subtitle" id="evidenceTiesHint" style="margin: 6px 0 0 0">
              No ties added yet.
            </p>
            <ul id="evidenceTiesList" class="ties-list"></ul>

            <label for="evidencePhoto">Photo (optional)</label>
            <input id="evidencePhoto" type="file" accept="image/*" />

            <div class="annotation-toolbar">
              <span class="subtitle">Annotate photo:</span>
              <div class="chip-row">
                <button
                  type="button"
                  class="secondary"
                  data-annotation-mode="arrow"
                >
                  Arrow
                </button>
                <button
                  type="button"
                  class="secondary"
                  data-annotation-mode="circle"
                >
                  Circle
                </button>
                <button
                  type="button"
                  class="secondary"
                  data-annotation-mode="text"
                >
                  Text label
                </button>
                <button type="button" id="evidenceAnnotationClear">
                  Clear annotations
                </button>
              </div>
            </div>

            <div class="photo-annotation-preview">
              <div id="evidencePhotoPreview" class="photo-preview">
                <canvas id="evidenceAnnotationCanvas"></canvas>
              </div>
              <p
                class="subtitle"
                id="evidencePhotoMetadataNote"
                style="margin-top: 6px"
              ></p>
            </div>

            <div
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button type="button" id="captureLocation">
                Get GPS Location
              </button>
              <span id="evidenceLocationStatus" class="subtitle"></span>
            </div>

            <div
              style="
                margin-top: 12px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button type="button" class="success" id="saveEvidenceButton">
                Save Evidence
              </button>
              <button type="button" id="resetEvidenceButton">Reset Form</button>
            </div>
          </div>

          <div class="card">
            <h3>Project Evidence Points</h3>
            <p class="subtitle" id="evidenceSummary" style="margin-top: 0"></p>
            <div id="evidenceList"></div>
          </div>
        </div>

        <div id="chainEvidenceSection" class="tool-section">
          <div class="card">
            <h3>Chain of Evidence</h3>
            <p class="subtitle" style="margin-top: 0">
              Review every monument with TRS context, linked sources, and QC
              status. Filter by TRS, classification, or project phase and
              export per-corner evidence packets.
            </p>

            <div class="form-grid">
              <div>
                <label for="chainTrsFilter">TRS filter</label>
                <input
                  id="chainTrsFilter"
                  type="text"
                  placeholder="e.g., T5N R3E Sec 12"
                />
              </div>
              <div>
                <label for="chainCornerTypeFilter">Corner type</label>
                <select id="chainCornerTypeFilter"></select>
              </div>
              <div>
                <label for="chainStatusFilter">Project phase</label>
                <select id="chainStatusFilter">
                  <option value="">All phases</option>
                  <option value="Draft">Draft</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Ready for Review">Ready for Review</option>
                  <option value="Final">Final</option>
                </select>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="chainStartDate">Start date</label>
                <input id="chainStartDate" type="date" />
              </div>
              <div>
                <label for="chainEndDate">End date</label>
                <input id="chainEndDate" type="date" />
              </div>
              <div>
                <label for="chainCornerStatusFilter">Corner status</label>
                <select id="chainCornerStatusFilter"></select>
              </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 12px">
              <button type="button" id="chainApplyFilters" class="secondary">
                Apply Filters
              </button>
              <button type="button" id="chainResetFilters">Reset</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <h3 style="margin: 0">Corner Evidence Register</h3>
                <p
                  class="subtitle"
                  style="margin: 4px 0 0 0"
                  id="chainEvidenceSummary"
                ></p>
              </div>
              <div class="view-toggle">
                <button type="button" id="chainExportAll" class="secondary">
                  Export Visible Corners
                </button>
              </div>
            </div>
            <div id="chainEvidenceList" class="chain-evidence-list"></div>
          </div>
        </div>

        <div id="researchSection" class="tool-section">
          <div class="card">
            <h3>Historical Research / Source Documentation</h3>
            <p class="subtitle" style="margin-top: 0">
              Catalog controlling, supporting, conflicting, and discarded
              sources with reviewer and TRS context.
            </p>

            <div class="form-grid">
              <div>
                <label for="researchDocumentType">Document type</label>
                <select id="researchDocumentType">
                  <option value="">Select‚Ä¶</option>
                  <option>GLO plat / field notes</option>
                  <option>Record of Survey</option>
                  <option>Subdivision plat / annexation</option>
                  <option>Deed / title chain</option>
                  <option>Easement</option>
                  <option>CP&amp;F</option>
                  <option>BLM summary/report</option>
                  <option>Agency correspondence</option>
                  <option>Other</option>
                </select>
              </div>
              <div>
                <label for="researchJurisdiction">Jurisdiction</label>
                <select id="researchJurisdiction">
                  <option value="">Select‚Ä¶</option>
                  <option>County</option>
                  <option>BLM</option>
                  <option>Federal</option>
                  <option>Private</option>
                  <option>Other</option>
                </select>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="researchInstrument">Instrument #</label>
                <input
                  id="researchInstrument"
                  type="text"
                  placeholder="Instrument number"
                />
              </div>
              <div>
                <label for="researchBookPage">Book / Page</label>
                <input
                  id="researchBookPage"
                  type="text"
                  placeholder="Book/Page"
                />
              </div>
              <div>
                <label for="researchDocumentNumber">Document #</label>
                <input
                  id="researchDocumentNumber"
                  type="text"
                  placeholder="Document number"
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="researchTownship">Township</label>
                <input
                  id="researchTownship"
                  type="text"
                  placeholder="T2N"
                />
              </div>
              <div>
                <label for="researchRange">Range</label>
                <input id="researchRange" type="text" placeholder="R3W" />
              </div>
              <div>
                <label for="researchSections">Section(s)</label>
                <input
                  id="researchSections"
                  type="text"
                  placeholder="11, 12"
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="researchAliquots">Aliquots</label>
                <input
                  id="researchAliquots"
                  type="text"
                  placeholder="NW1/4 SE1/4"
                />
              </div>
              <div>
                <label for="researchSource">Source reference</label>
                <input
                  id="researchSource"
                  type="text"
                  placeholder="URL, scanner source, or file path"
                />
              </div>
            </div>

            <div class="form-grid">
              <div>
                <label for="researchDateReviewed">Date reviewed</label>
                <input id="researchDateReviewed" type="date" />
              </div>
              <div>
                <label for="researchReviewer">Reviewer</label>
                <input
                  id="researchReviewer"
                  type="text"
                  placeholder="Survey crew or reviewer"
                />
              </div>
              <div>
                <label for="researchStatus">Status</label>
                <select id="researchStatus">
                  <option value="Draft">Draft</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Ready for Review">Ready for Review</option>
                  <option value="Final">Final</option>
                </select>
              </div>
              <div>
                <label for="researchClassification">Classification</label>
                <select id="researchClassification">
                  <option value="">Select‚Ä¶</option>
                  <option>Controlling</option>
                  <option>Supporting</option>
                  <option>Conflicting</option>
                  <option>Discarded (with reason)</option>
                </select>
              </div>
            </div>

            <label for="researchNotes">Annotation / reason</label>
            <textarea
              id="researchNotes"
              rows="3"
              placeholder="Explain acceptance, conflict, or discard rationale"
            ></textarea>

            <label for="researchCornerNotes">Corner or line notes</label>
            <textarea
              id="researchCornerNotes"
              rows="2"
              placeholder="e.g., Controls NE corner of Sec 12"
            ></textarea>

            <div class="form-grid">
              <div>
                <label for="researchTraverseLinks">Traverse / record links</label>
                <input
                  id="researchTraverseLinks"
                  type="text"
                  placeholder="Related traverses or record sets"
                />
              </div>
              <div>
                <label for="researchStakeoutLinks">Stakeout links</label>
                <input
                  id="researchStakeoutLinks"
                  type="text"
                  placeholder="Stakeout entries referenced by this document"
                />
              </div>
              <div>
                <label for="researchEvidenceSelect">Linked evidence</label>
                <select id="researchEvidenceSelect" multiple></select>
                <small class="app-hint">
                  Hold Ctrl/Command to link evidence items cited by this source.
                </small>
              </div>
              <div>
                <label for="researchCornerIds">TRS corner IDs</label>
                <input
                  id="researchCornerIds"
                  type="text"
                  placeholder="Corner IDs or monuments covered"
                />
                <small class="app-hint">
                  List specific corners or lines this document controls/conflicts.
                </small>
              </div>
            </div>

            <div
              style="
                margin-top: 12px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button type="button" class="success" id="saveResearchButton">
                Save Research Entry
              </button>
              <button type="button" id="resetResearchButton">Reset Form</button>
              <button type="button" id="exportResearchButton">
                Export Research Packet
              </button>
            </div>
            <div id="researchFormStatus" class="research-form-status"></div>
          </div>

          <div class="card">
            <h3>Research Register</h3>
            <p class="subtitle" id="researchSummary" style="margin-top: 0"></p>
            <div id="researchList"></div>
          </div>
        </div>

        <div id="equipmentSection" class="tool-section">
          <div class="card">
            <h3>Equipment Setup Log</h3>
            <p class="subtitle" style="margin-top: 0">
              Track base station setup and teardown information for this
              project.
            </p>

            <div class="form-grid equipment-grid">
              <div>
                <label for="equipmentSetupAt">Setup Date &amp; Time</label>
                <input id="equipmentSetupAt" type="datetime-local" />
              </div>
              <div>
                <label for="equipmentTearDownAt"
                  >Tear Down Date &amp; Time</label
                >
                <input id="equipmentTearDownAt" type="datetime-local" />
              </div>
            </div>

            <div class="form-grid equipment-grid">
              <div>
                <label for="equipmentBaseHeight">Base Station Height</label>
                <input
                  id="equipmentBaseHeight"
                  type="text"
                  placeholder="e.g., 1.500 m"
                />
              </div>
              <div>
                <label for="equipmentReferencePoint">Reference Point</label>
                <select id="equipmentReferencePointPicker"></select>
                <input
                  id="equipmentReferencePoint"
                  type="text"
                  placeholder="Control point or benchmark used"
                  list="equipmentReferencePointOptions"
                />
                <datalist id="equipmentReferencePointOptions"></datalist>
              </div>
            </div>

            <div class="form-grid equipment-grid">
              <div>
                <label for="equipmentSetupBy">Set Up By</label>
                <select id="equipmentSetupBy"></select>
              </div>
              <div>
                <label for="equipmentUsed">Equipment Used</label>
                <select id="equipmentUsed" multiple></select>
                <small class="app-hint">
                  Hold Ctrl (Windows) or Command (Mac) to select multiple
                  items.
                </small>
              </div>
              <div>
                <label for="captureEquipmentLocation">GPS Location</label>
                <div style="display: flex; gap: 10px; align-items: center">
                  <button type="button" id="captureEquipmentLocation">
                    Get GPS Location
                  </button>
                  <span id="equipmentLocationStatus" class="subtitle"></span>
                </div>
              </div>
            </div>

            <label for="equipmentWorkNotes">Work / Daily Goal</label>
            <textarea
              id="equipmentWorkNotes"
              placeholder="Describe today's objectives or tasks to pair with this setup"
            ></textarea>

            <div id="equipmentFormStatus" class="equipment-form-status"></div>

            <div
              style="
                margin-top: 12px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
              "
            >
              <button type="button" class="success" id="saveEquipmentButton">
                Save Equipment Entry
              </button>
              <button type="button" id="resetEquipmentButton">
                Reset Form
              </button>
            </div>
          </div>

          <div class="card">
            <h3>Equipment Records</h3>
            <p class="subtitle" id="equipmentSummary" style="margin-top: 0"></p>
            <div id="equipmentList"></div>
          </div>
        </div>

        <div id="stakeoutSection" class="tool-section">
          <div class="card">
            <h3>Stakeout / Field Notes</h3>
            <p class="subtitle" style="margin-top: 0">
              Log monument settings, witness marks, and other field tasks with
              crew and equipment context.
            </p>

            <div class="form-grid stakeout-grid">
              <div>
                <label for="stakeoutDatetime">Date &amp; time</label>
                <input id="stakeoutDatetime" type="datetime-local" />
              </div>
              <div>
                <label for="stakeoutMonumentType">Monument type placed</label>
                <input
                  id="stakeoutMonumentType"
                  type="text"
                  placeholder="Rebar w/ aluminum cap, PK nail, spike..."
                />
              </div>
              <div>
                <label for="stakeoutMonumentMaterial">Material / size</label>
                <input
                  id="stakeoutMonumentMaterial"
                  type="text"
                  placeholder="5/8&quot; rebar x 24&quot;, brass cap, etc."
                />
              </div>
              <div>
                <label for="stakeoutTraverseSelect">Controlling traverse</label>
                <select id="stakeoutTraverseSelect"></select>
              </div>
            </div>

            <div class="form-grid stakeout-grid">
              <div>
                <label for="stakeoutCrewMembers">Crew present</label>
                <select id="stakeoutCrewMembers" multiple></select>
                <small class="app-hint">
                  Hold Ctrl (Windows) or Command (Mac) to select multiple crew
                  members.
                </small>
              </div>
              <div>
                <label for="stakeoutEquipmentUsed">Equipment used</label>
                <select id="stakeoutEquipmentUsed" multiple></select>
                <small class="app-hint">
                  Use equipment codes from global settings; select all units
                  involved.
                </small>
              </div>
              <div>
                <label for="stakeoutEvidenceSelect">Linked evidence</label>
                <select id="stakeoutEvidenceSelect"></select>
              </div>
              <div>
                <label for="stakeoutControlPoints">Control points used</label>
                <input
                  id="stakeoutControlPoints"
                  type="text"
                  placeholder="Point numbers or descriptions"
                />
              </div>
            </div>

            <div class="form-grid stakeout-grid">
              <div>
                <label for="stakeoutWitnessMarks">Witness marks / ties</label>
                <textarea
                  id="stakeoutWitnessMarks"
                  placeholder="Reference ties, witness posts, guard stakes..."
                ></textarea>
              </div>
              <div>
                <label for="stakeoutDigNotes">Dig notes / soil</label>
                <textarea
                  id="stakeoutDigNotes"
                  placeholder="Depth, obstructions, disturbed material, soil/rock notes"
                ></textarea>
              </div>
            </div>

            <div class="stakeout-actions">
              <button type="button" class="success" id="saveStakeoutButton">
                Save stakeout entry
              </button>
              <button type="button" id="resetStakeoutButton">Reset form</button>
              <span id="stakeoutFormStatus" class="mini-note"></span>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 style="margin: 0">Stakeout log</h3>
              <span id="stakeoutSummary" class="mini-note"></span>
            </div>
            <div id="stakeoutList" class="stakeout-list"></div>
          </div>
        </div>

        <div id="navigationSection" class="tool-section">
          <div class="card">
            <h3>Navigation</h3>
            <p class="subtitle" style="margin-top: 0">
              Draw a compass, follow headings, and return to important project
              locations. Capture stakeout targets, travel headings, and
              equipment bases so you can walk the correct line in the field.
            </p>

            <div class="navigation-grid">
              <div class="navigation-panel compass-wrapper">
                <div class="navigation-toolbar">
                  <button id="navigationToggleView" class="secondary">
                    Switch to Map View
                  </button>
                </div>
                <canvas
                  id="navigationCompass"
                  width="320"
                  height="320"
                ></canvas>
                <div class="compass-readouts">
                  <div class="stat-chip">
                    <div class="stat-label">Heading Source</div>
                    <div class="stat-value" id="navigationHeadingValue">--</div>
                  </div>
                  <div class="stat-chip">
                    <div class="stat-label">Target Bearing</div>
                    <div class="stat-value" id="navigationTargetBearing">
                      --
                    </div>
                  </div>
                  <div class="stat-chip">
                    <div class="stat-label">Distance to Target</div>
                    <div class="stat-value" id="navigationTargetDistance">
                      --
                    </div>
                  </div>
                  <div class="stat-chip">
                    <div class="stat-label">Line Offset</div>
                    <div class="stat-value" id="navigationOffset">--</div>
                  </div>
                </div>
                <div
                  class="subtitle"
                  id="navigationStatus"
                  style="margin: 0"
                ></div>
                <div class="stat-chip" style="width: 100%">
                  <div class="stat-label">Nearest points</div>
                  <div class="nearby-points" id="nearestPointsList">
                    Waiting for GPS fix‚Ä¶
                  </div>
                </div>
              </div>

              <div
                class="navigation-panel navigation-map hidden"
                id="navigationMapPanel"
              >
                <h4 style="margin-top: 0">Map Preview</h4>
                <img
                  id="navigationMapFrame"
                  alt="Navigation Map"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                />
                <div class="stat-chip">
                  <div class="stat-label">Map Status</div>
                  <div class="stat-value" id="navigationMapStatus">
                    Apply GPS localization to view the map.
                  </div>
                </div>
              </div>

              <div class="navigation-panel navigation-actions">
                <h4>Targets &amp; Saved Spots</h4>
                <div class="card" style="margin: 0 0 12px 0; padding: 12px">
                  <h4 style="margin: 0 0 8px 0">GPS Localization</h4>
                  <p
                    class="subtitle"
                    id="localizationSummary"
                    style="margin: 0 0 8px 0"
                  >
                    Choose a known point and enter its GPS coordinates to
                    convert local traverse and point file coordinates into
                    navigation targets.
                  </p>
                  <label for="localizationSource">Anchor Source</label>
                  <select id="localizationSource">
                    <option value="traverse">Traverse point</option>
                    <option value="pointFile">Point file</option>
                  </select>

                  <div id="localizationTraverseFields">
                    <label for="localizationRecord">Traverse record</label>
                    <select id="localizationRecord"></select>
                    <label for="localizationTraversePoint"
                      >Traverse point</label
                    >
                    <select id="localizationTraversePoint"></select>
                  </div>

                  <div id="localizationPointFileFields" style="display: none">
                    <label for="localizationPointFile">Point file</label>
                    <select id="localizationPointFile"></select>
                    <label for="localizationPointNumber">Point number</label>
                    <select id="localizationPointNumber"></select>
                  </div>

                  <div class="form-grid" style="margin-top: 12px">
                    <div>
                      <label for="localizationLat">Anchor Latitude</label>
                      <input
                        type="text"
                        id="localizationLat"
                        placeholder="e.g., 34.123456"
                      />
                    </div>
                    <div>
                      <label for="localizationLon">Anchor Longitude</label>
                      <input
                        type="text"
                        id="localizationLon"
                        placeholder="e.g., -117.123456"
                      />
                    </div>
                  </div>

                  <div
                    style="
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                      margin-top: 10px;
                    "
                  >
                    <button
                      type="button"
                      class="success"
                      id="applyLocalization"
                    >
                      Apply GPS localization
                    </button>
                    <button
                      type="button"
                      class="secondary"
                      id="clearLocalization"
                    >
                      Clear localization
                    </button>
                  </div>
                  <div
                    class="subtitle"
                    id="localizationStatus"
                    style="margin-top: 6px"
                  ></div>
                </div>
                <label for="navigationBookmarkName"
                  >Name to save current position</label
                >
                <input
                  type="text"
                  id="navigationBookmarkName"
                  placeholder="E.g., Truck, Property corner, Cache"
                />
                <div class="form-grid">
                  <div>
                    <label for="navigationCornerType">Corner Type (PLSS)</label>
                    <select id="navigationCornerType">
                      <option value="">Select‚Ä¶</option>
                      <option>Section corner</option>
                      <option>Quarter corner</option>
                      <option>Sixteenth corner</option>
                      <option>Lot corner</option>
                      <option>Meander corner</option>
                      <option>Witness corner</option>
                      <option>Other</option>
                    </select>
                  </div>
                  <div>
                    <label for="navigationCornerStatus">Corner Status</label>
                    <select id="navigationCornerStatus">
                      <option value="">Select‚Ä¶</option>
                      <option>Original monument found</option>
                      <option>Perpetuation monument found</option>
                      <option>Obliterated/restored by collateral evidence</option>
                      <option>Lost/proportionally restored</option>
                      <option>New monument set</option>
                      <option>Witness corner set</option>
                    </select>
                  </div>
                </div>
                <button id="saveNavigationBookmark">
                  Save current location
                </button>
                <div class="subtitle" id="navigationBookmarkStatus"></div>

                <label for="navigationTargetSelect">Navigate to</label>
                <select id="navigationTargetSelect"></select>

                <label for="navigationEquipmentSelect"
                  >Equipment setup (base)</label
                >
                <select id="navigationEquipmentSelect"></select>

                <div
                  style="
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                    margin-top: 4px;
                  "
                >
                  <button class="secondary" id="refreshNavigation">
                    Refresh sources
                  </button>
                  <button id="clearNavigationTarget" class="danger">
                    Clear target
                  </button>
                </div>

                <div class="bookmark-list" id="navigationBookmarksList"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="settingsSection" class="tool-section">
          <div class="card">
            <h3>Global Settings</h3>
            <p class="subtitle" style="margin-top: 0">
              Configure reusable data shared across projects and keep a backup
              of everything stored in this app.
            </p>

            <div class="form-grid">
              <div class="card" style="margin-top: 0">
                <h4 style="margin-top: 0">Professional Profile</h4>
                <p class="subtitle" style="margin-top: 0">
                  This information appears on exports (CP&amp;F, QC summaries,
                  level books, and Smart Pack) so filings include Idaho-ready
                  identification.
                </p>
                <div class="form-grid">
                  <label>
                    Responsible surveyor
                    <input
                      type="text"
                      id="professionalSurveyorName"
                      placeholder="Name"
                    />
                  </label>
                  <label>
                    Idaho PLS #
                    <input type="text" id="professionalLicense" />
                  </label>
                  <label>
                    Firm
                    <input type="text" id="professionalFirm" />
                  </label>
                  <label>
                    Contact phone
                    <input type="tel" id="professionalContactPhone" />
                  </label>
                  <label>
                    Contact email
                    <input type="email" id="professionalContactEmail" />
                  </label>
                  <label>
                    Primary county
                    <input type="text" id="professionalCounty" />
                  </label>
                </div>
                <div class="input-row" style="margin-top: 8px">
                  <button type="button" id="saveProfessionalProfileButton">
                    Save Profile
                  </button>
                  <button
                    type="button"
                    class="secondary"
                    id="resetProfessionalProfileButton"
                  >
                    Reset
                  </button>
                  <div class="subtitle" id="professionalProfileStatus"></div>
                </div>
              </div>

              <div class="card" style="margin-top: 0">
                <h4 style="margin-top: 0">Equipment Library</h4>
                <div class="form-grid">
                  <label>
                    Name
                    <input
                      type="text"
                      id="equipmentNameInput"
                      placeholder="Base 1, Rover, Receiver"
                    />
                  </label>
                  <label>
                    Make
                    <input type="text" id="equipmentMakeInput" />
                  </label>
                  <label>
                    Model
                    <input type="text" id="equipmentModelInput" />
                  </label>
                  <label>
                    Manual URL
                    <input
                      type="url"
                      id="equipmentManualInput"
                      placeholder="https://manufacturer.example/manual"
                    />
                  </label>
                  <label class="full-width">
                    Notes
                    <textarea
                      id="equipmentNotesInput"
                      rows="2"
                      placeholder="Calibration info, known issues"
                    ></textarea>
                  </label>
                </div>
                <div class="input-row" style="margin-top: 8px">
                  <button type="button" id="saveEquipmentButton">
                    Save Equipment
                  </button>
                  <button type="button" id="resetEquipmentButton">
                    Reset
                  </button>
                  <div class="subtitle" id="equipmentEditHint"></div>
                </div>
                <table class="calls-table" style="margin-top: 12px">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Make/Model</th>
                      <th>Manual</th>
                      <th>Notes</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="equipmentTableBody"></tbody>
                </table>
              </div>

              <div class="card" style="margin-top: 0">
                <h4 style="margin-top: 0">Team Members</h4>
                <div class="form-grid">
                  <label>
                    Name
                    <input
                      type="text"
                      id="teamMemberInput"
                      placeholder="Crew Chief, Rodman"
                    />
                  </label>
                  <label>
                    Role
                    <input type="text" id="teamMemberRoleInput" />
                  </label>
                  <label>
                    Title
                    <input type="text" id="teamMemberTitleInput" />
                  </label>
                  <label>
                    Phone
                    <input type="tel" id="teamMemberPhoneInput" />
                  </label>
                  <label>
                    Email
                    <input type="email" id="teamMemberEmailInput" />
                  </label>
                </div>
                <div class="input-row" style="margin-top: 8px">
                  <button type="button" id="saveTeamMemberButton">Save</button>
                  <button type="button" id="resetTeamMemberButton">
                    Reset
                  </button>
                  <div class="subtitle" id="teamMemberEditHint"></div>
                </div>
                <table class="calls-table" style="margin-top: 12px">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Role/Title</th>
                      <th>Contact</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="teamMemberTableBody"></tbody>
                </table>
              </div>
            </div>

            <div class="card" style="margin-top: 12px">
              <h4 style="margin-top: 0">Device Identity</h4>
              <p class="subtitle" style="margin-top: 0">
                Assign this device to a team member so other users can see your
                name alongside your shared location.
              </p>
              <label for="deviceTeamMemberSelect">This device belongs to</label>
              <select id="deviceTeamMemberSelect"></select>
              <div class="subtitle" id="deviceIdentifierHint"></div>
            </div>

            <div class="card" style="margin-top: 12px">
              <h4 style="margin-top: 0">Point Codes</h4>
              <div class="input-row">
                <input type="text" id="pointCodeInput" placeholder="Code" />
                <input
                  type="text"
                  id="pointCodeDescriptionInput"
                  placeholder="Description"
                />
                <select id="pointCodeKindSelect">
                  <option value="line">Line type</option>
                  <option value="point" selected>Point/symbol type</option>
                </select>
                <button type="button" id="savePointCodeButton">Save</button>
                <button type="button" id="resetPointCodeButton">Reset</button>
                <div class="subtitle" id="pointCodeEditHint"></div>
              </div>
              <table class="calls-table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="pointCodeTableBody"></tbody>
              </table>
            </div>

            <div class="card" style="margin-top: 12px">
              <h4 style="margin-top: 0">Backup &amp; Restore</h4>
              <p class="subtitle" style="margin-top: 0">
                Download a single file with all projects, evidence, and global
                settings or import one to restore.
              </p>
              <div class="form-grid">
                <label class="checkbox-row">
                  <input type="checkbox" id="enableRollingBackups" />
                  <span>Keep a rolling backup (last 3 exports per project)</span>
                </label>
                <label>
                  Backup filename prefix
                  <input
                    type="text"
                    id="backupFilenamePrefix"
                    placeholder="carlson-backup"
                  />
                </label>
              </div>
              <div style="display: flex; gap: 10px; flex-wrap: wrap">
                <button type="button" id="exportAllDataButton">
                  Download All App Data
                </button>
                <button type="button" id="importAllDataButton">
                  Import App Data
                </button>
              </div>
              <div class="mini-note" id="rollingBackupHint">
                Rolling backups are disabled.
              </div>
              <div id="rollingBackupList" class="backup-list"></div>
              <div style="display: flex; gap: 8px; margin-top: 8px">
                <button type="button" class="secondary" id="refreshBackupList">
                  Refresh backups
                </button>
                <button type="button" class="danger" id="clearProjectBackups">
                  Clear backups for this project
                </button>
              </div>
            </div>

            <p class="subtitle" style="margin-top: 12px">
              All data saved locally in your browser ‚Ä¢ No server ‚Ä¢ Works
              offline
            </p>
          </div>
        </div>

        <div id="helpSection" class="tool-section">
          <div class="card">
            <div class="card-header">
              <div>
                <h3 style="margin-top: 0">Help &amp; Guidance</h3>
                <p class="subtitle" style="margin-top: 0">
                  This view reads from HELP.md so the in-app help always matches
                  your documentation file.
                </p>
              </div>
              <div class="help-actions">
                <span id="helpStatus" class="mini-note"></span>
              </div>
            </div>
            <div id="helpContent" class="help-content">
              <p class="subtitle">Loading help content‚Ä¶</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden file input for import -->
    <input
      type="file"
      id="importFileInput"
      style="display: none"
      accept=".json,application/json"
    />
    <input
      type="file"
      id="importAllDataInput"
      style="display: none"
      accept=".json,application/json"
    />
    <input
      type="file"
      id="auditFileInput"
      style="display: none"
      accept=".json,application/json"
    />

    <div class="footer">
      All data saved locally in your browser ‚Ä¢ No server ‚Ä¢ Works offline
    </div>

    <script type="module" src="js/app.js"></script>
  </body>
</html>
